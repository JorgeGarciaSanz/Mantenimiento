name: CI/CD con Docker

on:
  push:
    branches:
      - main # Se activa cuando hay un push a la rama principal

jobs:
  build-test-scan:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: âš™ï¸ Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -------------------------------------------------------------------------
      # FASE CI: ConstrucciÃ³n de Imagen (Solo para Buildx)
      # -------------------------------------------------------------------------
      - name: ğŸ—ï¸ Construir la Imagen Docker (CI)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.txt
          tags: mi-app-test:latest
          push: false
          load: true # <--- Â¡CLAVE! Esto asegura que la imagen se almacene localmente

      # -------------------------------------------------------------------------
      # FASE CI: Ejecutar Pruebas (Ajuste de Red y Tiempos)
      # -------------------------------------------------------------------------
      - name: ğŸ§ª Ejecutar Pruebas de IntegraciÃ³n (Usando Host)
        run: |
          # 1. Ejecutamos el servidor de la app en background (El ENTRYPOINT ahora es estable)
          docker run -d --rm --name test_server -p 3000:3000 mi-app-test:latest 
          
          # 2. Esperamos y usamos el bucle de health check (curl)
          echo "Esperando a que el servidor responda en el host (localhost:3000)..."
          
          # Bucle que intenta conectar con curl hasta 10 veces (mÃ¡x. 20 segundos)
          for i in {1..10}; do
            # curl intenta conectarse a localhost:3000 (el host del runner)
            response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000)
            if [ "$response" -eq 200 ]; then
              echo "âœ… Prueba de conexiÃ³n exitosa: CÃ³digo 200. Servidor listo."
              break
            fi
            echo "Intento $i/10 fallido (CÃ³digo: $response). Reintentando en 2 segundos..."
            sleep 2
            if [ "$i" -eq 10 ]; then
              echo "âŒ El servidor no respondiÃ³ despuÃ©s de 10 intentos."
              docker stop test_server
              exit 1
            fi
          done
          
          # 3. Limpiamos: detenemos y eliminamos el contenedor
          docker stop test_server
          docker rm test_server
        working-directory: .
        
      # -------------------------------------------------------------------------
      # FASE CI: Escaneo de Seguridad (DevSecOps)
      # -------------------------------------------------------------------------
      - name: ğŸ”’ Escanear Imagen con Trivy (Seguridad)
        # Usamos la imagen construida 'mi-app-test:latest'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'mi-app-test:latest' 
          format: 'table'
          exit-code: '1' # Falla si encuentra CRITICAL o HIGH
          severity: 'CRITICAL,HIGH'

      # -------------------------------------------------------------------------
      # FASE CD: Entrega Continua (Subida a Docker Hub)
      # -------------------------------------------------------------------------
      - name: ğŸš€ Login y Push a Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      - name: ğŸ“¦ Subir Imagen a Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.txt # Usamos .txt ya que lo mantuviste con esa extensiÃ³n
          push: true
          # Etiqueta con el hash de Git para inmutabilidad y 'latest' para facilidad
          tags: ${{ secrets.DOCKER_USERNAME }}/mi-app-ci:v${{ github.sha }}, ${{ secrets.DOCKER_USERNAME }}/mi-app-ci:latest

      # -------------------------------------------------------------------------
      # FASE CD: Despliegue Continuo (Desactivado hasta que la CI pase)
      # -------------------------------------------------------------------------
      # - name: ğŸŒ Despliegue Continuo (CD) - (Simulado con SSH/Script)
      #   uses: appleboy/ssh-action@master
      #   with:
      #     host: ${{ secrets.SSH_HOST }}
      #     username: ${{ secrets.SSH_USERNAME }}
      #     key: ${{ secrets.SSH_KEY }}
      #     script: |
      #       echo "Iniciando despliegue en el servidor..."
      #       docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
      #       docker pull ${{ secrets.DOCKER_USERNAME }}/mi-app-ci:v${{ github.sha }}
      #       docker stop mi-app-web || true
      #       docker rm mi-app-web || true
      #       docker run -d --name mi-app-web -p 80:3000 ${{ secrets.DOCKER_USERNAME }}/mi-app-ci:v${{ github.sha }}
      #       echo "Despliegue de la versiÃ³n v${{ github.sha }} finalizado."