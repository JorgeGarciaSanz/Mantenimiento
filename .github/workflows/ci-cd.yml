name: CI/CD con Docker

on:
  push:
    branches:
      - main # Se activa cuando hay un push a la rama principal

jobs:
  build-test-scan:
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout del c√≥digo
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üèóÔ∏è Construir la Imagen Docker (CI)
        # Construye la imagen, pero no la sube a√∫n
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.txt
          tags: ${{ secrets.DOCKER_USERNAME }}/mi-app-ci:latest
          push: false # No subir todav√≠a

      

      - name: üß™ Ejecutar Pruebas dentro de un Contenedor
        run: |
          # 1. Reconstruimos la imagen con el nombre temporal (Aseg√∫rate de que esta l√≠nea est√© correcta)
          docker build -t mi-app-test:latest -f Dockerfile.txt .
          
          # 2. Ejecutamos el servidor de la app en background (puerto 3000) y le asignamos un nombre
          # Notar: el comando 'npm start' ejecuta 'node app.js'
          docker run -d --name test_server mi-app-test:latest npm start
          
          # 3. Esperamos 5 segundos para que el servidor se inicie completamente
          sleep 5
          
          # 4. Ejecutamos la prueba (test.js) en un nuevo contenedor, conectado al servidor de prueba
          # Usamos --network container:test_server para que 'localhost' en la prueba apunte al servidor de la app
          docker run --rm --network container:test_server mi-app-test:latest npm test
          
          # 5. Limpiamos: detenemos y removemos el contenedor del servidor en background
          docker stop test_server
          docker rm test_server
        working-directory: .




      - name: üîí Escanear Imagen con Trivy (Seguridad)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'mi-app-test:latest' # Escanea la imagen reci√©n construida
          format: 'table'
          exit-code: '1' # Falla si encuentra vulnerabilidades cr√≠ticas
          severity: 'CRITICAL,HIGH'

      - name: üöÄ Login y Push a Docker Hub (CD - Entrega)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      - name: üì¶ Subir Imagen a Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true # Ahora s√≠, la subimos
          tags: ${{ secrets.DOCKER_USERNAME }}/mi-app-ci:v${{ github.sha }} # Tag con el hash de Git para inmutabilidad

      - name: üåç Despliegue Continuo (CD) - (Simulado con SSH/Script)
        # ESTE ES UN PASO SIMULADO. Debes adaptarlo a tu servidor.
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "Iniciando despliegue en el servidor..."
            docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
            docker pull ${{ secrets.DOCKER_USERNAME }}/mi-app-ci:v${{ github.sha }}
            docker stop mi-app-web || true
            docker rm mi-app-web || true
            docker run -d --name mi-app-web -p 80:3000 ${{ secrets.DOCKER_USERNAME }}/mi-app-ci:v${{ github.sha }}
            echo "Despliegue de la versi√≥n v${{ github.sha }} finalizado."