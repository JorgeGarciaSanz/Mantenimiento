# -------------------------------------------------------------------
# 1. ETAPA DE CONSTRUCCIÓN: Utilizada para instalar dependencias
# -------------------------------------------------------------------
FROM node:20-alpine AS builder

# Establece el directorio de trabajo
WORKDIR /app

# CRÍTICO: Copia package.json desde la raíz del contexto (donde está el Dockerfile)
COPY package*.json ./
RUN npm install

# Copia la aplicación (app.js) y el resto del código desde src/
COPY src/ .
# Copia la carpeta de pruebas (test/)
COPY test/ ./

# -------------------------------------------------------------------
# 2. ETAPA DE PRODUCCIÓN: Imagen final, ligera y segura
# -------------------------------------------------------------------
FROM node:20-alpine AS final

# Configuración: Establece el puerto, el usuario y el directorio
WORKDIR /usr/src/app
ENV NODE_ENV production
EXPOSE 3000

# Copia SOLO los artefactos esenciales de la etapa 'builder'
COPY --from=builder /app .

# CRÍTICO: Aseguramos que el script de inicio de la aplicación tenga permisos de ejecución
RUN chmod +x app.js

# Comando principal para iniciar la aplicación
ENTRYPOINT ["node", "app.js"]