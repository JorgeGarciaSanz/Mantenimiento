# -------------------------------------------------------------------
# 1. ETAPA DE CONSTRUCCIÓN: Utilizada para instalar dependencias
# -------------------------------------------------------------------
FROM node:20-alpine AS builder

# Establece el directorio de trabajo
WORKDIR /app

# CRÍTICO: Copia package.json desde la raíz del contexto (donde está el Dockerfile)
COPY package*.json ./
RUN npm install

# Copia la aplicación (app.js) y el resto del código desde src/
COPY src/ .
# Copia la carpeta de pruebas (test/)
COPY test/ ./

# -------------------------------------------------------------------
# 2. ETAPA DE PRODUCCIÓN: Imagen final, ligera y segura
# Utiliza una imagen base minimalista para el runtime
# -------------------------------------------------------------------
FROM node:20-alpine AS final

# Configuración: Establece el puerto, el usuario y el directorio
WORKDIR /usr/src/app
# Define la variable de entorno para producción
ENV NODE_ENV production
# Expone el puerto que usa la aplicación (3000)
EXPOSE 3000

# Copia SOLO los artefactos esenciales de la etapa 'builder'
# Esto incluye los node_modules instalados, el código fuente (src/) y la carpeta test/
COPY --from=builder /app .

# Comando principal para iniciar la aplicación
# Ejecuta el script 'start' definido en package.json (node app.js)
CMD ["npm", "start"]